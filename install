#!/bin/bash

BASHKIT_INSTALL=/usr/local/bashkit
BIN_FOLDER=/usr/local/bin

ME=$(whoami)
ME_GROUP=$(id -g -n $ME)

MESSAGE_INFO="bashkit is being installed to $BASHKIT_INSTALL for the user $ME"

echo $MESSAGE_INFO
echo -e "\x1B[90m${MESSAGE_INFO//?/=}\x1B[39m"
echo "Installation requires sudo permissions:"

sudo bash <<EOF
	error () {
		echo -e "\x1B[31m\$*\x1B[39m" && exit 1
	}

	[ -e $BASHKIT_INSTALL ] && error "Install folder is not empty"
	echo "Installing now..."
	git clone -q git://github.com/mafintosh/bashkit.git $BASHKIT_INSTALL 2> /dev/null || error "Installation failed. Are you online?"
	chown -R $ME:$ME_GROUP $BASHKIT_INSTALL
	chown $ME:$ME_GROUP $BIN_FOLDER
EOF

[ $? != 0 ] && exit 1

ln -s $BIN_FOLDER $BASHKIT_INSTALL/bin
mkdir -p $BASHKIT_INSTALL/apps
rm -f $BIN_FOLDER/bashkit
ln -s $BASHKIT_INSTALL/bashkit $BIN_FOLDER/bashkit

BASH_PROFILE="$HOME/.bash_profile"
[ ! -e $BASH_PROFILE ] && BASH_PROFILE="$HOME/.bashrc"

if cat $BASH_PROFILE 2> /dev/null | grep "## bashkit installation ##" > /dev/null; then
	: # already linked in rc
else
	printf '\n## bashkit installation ##\n[ -e %s ] && . %s\n' $BASHKIT_INSTALL/bashrc $BASHKIT_INSTALL/bashrc >> $BASH_PROFILE
fi

echo "Installation complete. Try running 'bashkit'"
